<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin – Products</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 p-6">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-2xl font-bold mb-4">Admin – Products</h1>

    <!-- Add Product Form -->
    <form class="bg-white p-4 rounded shadow space-y-3 max-w-md">
      <input id="pname" placeholder="Product Name" required class="w-full p-2 border rounded" />
      <input id="pprice" type="number" placeholder="Price" required class="w-full p-2 border rounded" />
      <input id="pcategory" placeholder="Category (e.g., Skincare)" class="w-full p-2 border rounded" />

      <textarea id="pdesc" placeholder="Product Description" class="w-full p-2 border rounded" rows="4"></textarea>

      <input id="pimageFile" type="file" accept="image/*" class="w-full p-2 border rounded bg-white" />
      <p class="text-xs text-gray-500">Optional: choose an image file (jpg/png/webp).</p>

      <button id="addBtn" class="bg-red-600 text-white px-4 py-2 rounded w-full">
        Add Product
      </button>

      <p id="msg" class="text-sm text-red-600"></p>
    </form>

    <!-- Product List -->
    <hr class="my-6" />
    <h2 class="text-xl font-bold mb-3">All Products</h2>
    <div id="productList" class="space-y-3"></div>
  </div>

  <script>
    const BASE_URL = "https://pure-han-korea-production.up.railway.app";
    const API = `${BASE_URL}/api`;

    // ===== Auth helpers =====
    function getCleanToken() {
      const raw = localStorage.getItem("token") || "";
      return raw.startsWith("Bearer ") ? raw.slice(7) : raw;
    }

    const user = JSON.parse(localStorage.getItem("user") || "null");

    if (!getCleanToken() || !user || user.role !== "admin") {
      alert("Access denied. Admin only.");
      window.location.href = "login.html";
    }

    function setMsg(text) {
      document.getElementById("msg").textContent = text || "";
    }

    // ✅ Fix: handle both relative "/uploads/..." and full "https://..."
    function resolveImageUrl(imageValue) {
      if (!imageValue) return "";
      const v = String(imageValue).trim();
      if (v.startsWith("http://") || v.startsWith("https://")) return v;
      if (v.startsWith("/")) return BASE_URL + v;
      return BASE_URL + "/" + v;
    }

    // ===== Load products list =====
    async function loadProducts() {
      const box = document.getElementById("productList");
      box.innerHTML = "Loading...";

      try {
        const res = await fetch(`${API}/products`);
        const products = await res.json().catch(() => null);

        if (!res.ok) {
          box.innerHTML = (products?.message || "Failed to load products.");
          return;
        }

        if (!Array.isArray(products) || products.length === 0) {
          box.innerHTML = "No products found.";
          return;
        }

        box.innerHTML = products.map(p => {
          const imgUrl = resolveImageUrl(p.image);

          return `
            <div class="border rounded p-3 bg-white">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                  ${imgUrl
                    ? `<img src="${imgUrl}" class="w-14 h-14 object-cover rounded border" />`
                    : `<div class="w-14 h-14 rounded border bg-gray-50 flex items-center justify-center text-xs text-gray-400">No Img</div>`
                  }

                  <div>
                    <div class="font-semibold">${p.name}</div>
                    <div class="text-sm text-gray-600">PKR ${p.price} • ${p.category || "General"}</div>
                    ${p.description ? `<div class="text-sm text-gray-700 mt-1">${p.description}</div>` : ""}
                    <div class="text-xs text-gray-400 mt-1">${p._id || ""}</div>
                  </div>
                </div>

                <button
                  class="bg-red-600 text-white px-3 py-2 rounded"
                  onclick="deleteProduct('${p._id}')"
                >
                  Delete
                </button>
              </div>
            </div>
          `;
        }).join("");

      } catch (e) {
        box.innerHTML = "Network error while loading products.";
      }
    }

    // ===== Delete product =====
    async function deleteProduct(id) {
      if (!confirm("Delete this product?")) return;

      try {
        const res = await fetch(`${API}/products/${id}`, {
          method: "DELETE",
          headers: {
            Authorization: `Bearer ${getCleanToken()}`
          }
        });

        const data = await res.json().catch(() => ({}));

        if (!res.ok) {
          alert(data.message || "Delete failed");
          return;
        }

        alert("Deleted ✅");
        loadProducts();

      } catch (e) {
        alert("Network error: " + e.message);
      }
    }
    window.deleteProduct = deleteProduct;

    // ===== Add product (with optional image upload) =====
    document.getElementById("addBtn").addEventListener("click", async (e) => {
      e.preventDefault();
      setMsg("");

      const name = document.getElementById("pname").value.trim();
      const price = Number(document.getElementById("pprice").value);
      const category = document.getElementById("pcategory").value.trim() || "General";
      const description = document.getElementById("pdesc").value.trim();

      if (!name || !price) {
        setMsg("Name and price are required.");
        return;
      }

      // ✅ Keep image stored as RELATIVE path ("/uploads/...")
      let image = "";
      const file = document.getElementById("pimageFile")?.files?.[0];

      // 1) Upload image (optional)
      if (file) {
        const fd = new FormData();
        fd.append("image", file);

        let uploadRes;
        try {
          // ✅ Correct endpoint: /api/upload
          uploadRes = await fetch(`${API}/upload`, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${getCleanToken()}`
              // Do NOT set Content-Type manually for FormData
            },
            body: fd
          });
        } catch (err) {
          setMsg("Upload request failed: " + err.message);
          return;
        }

        const uploadData = await uploadRes.json().catch(() => ({}));

        if (!uploadRes.ok) {
          setMsg((uploadData.message || "Image upload failed") + ` (Status: ${uploadRes.status})`);
          return;
        }

        // expected: { url: "/uploads/....jpg" }
        image = uploadData.url || "";
      }

      // 2) Create product
      try {
        const res = await fetch(`${API}/products`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${getCleanToken()}`
          },
          body: JSON.stringify({ name, price, category, description, image })
        });

        const data = await res.json().catch(() => ({}));

        if (!res.ok) {
          setMsg(data.message || "Failed to add product");
          return;
        }

        alert("Product added ✅");

        document.getElementById("pname").value = "";
        document.getElementById("pprice").value = "";
        document.getElementById("pcategory").value = "";
        document.getElementById("pdesc").value = "";
        document.getElementById("pimageFile").value = "";

        loadProducts();

      } catch (e) {
        setMsg("Network error: " + e.message);
      }
    });

    loadProducts();
  </script>

</body>
</html>
